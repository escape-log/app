<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>集中タイマー PWA</title>
    <link rel="manifest" id="my-manifest">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#4a90e2">
    <style>
        :root {
            --primary: #4a90e2;
            --danger: #e94b35;
            --success: #2ecc71;
            --bg: #f4f7f6;
        }
        body { font-family: sans-serif; background: var(--bg); display: flex; justify-content: center; padding: 20px; }
        .card { background: white; padding: 2rem; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 100%; max-width: 400px; text-align: center; }
        .timer { font-size: 5rem; font-weight: bold; margin: 20px 0; color: #333; }
        .btn { border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 1rem; margin: 5px; transition: 0.2s; }
        .btn-start { background: var(--primary); color: white; }
        .btn-stop { background: var(--danger); color: white; }
        .history { margin-top: 30px; text-align: left; max-height: 200px; overflow-y: auto; font-size: 0.9rem; }
        .history-item { border-bottom: 1px solid #eee; padding: 5px 0; }
        .success-text { color: var(--success); font-weight: bold; }
        .fail-text { color: var(--danger); }
    </style>
</head>
<body>

<div class="card">
    <h2>集中タイマー</h2>
    <div class="timer" id="display">25:00</div>
    
    <div id="controls">
        <button class="btn btn-start" id="startBtn">スタート</button>
        <button class="btn btn-stop" id="stopBtn" disabled>中断</button>
    </div>

    <div class="history">
        <h3>これまでの記録</h3>
        <div id="historyList"></div>
    </div>
</div>

<script>
/**
 * PWA設定の動的生成
 */
const manifest = {
    "name": "集中タイマー PWA",
    "short_name": "タイマー",
    "start_url": ".",
    "display": "standalone",
    "background_color": "#f4f7f6",
    "theme_color": "#4a90e2",
    "icons": [{
        "src": "https://cdn-icons-png.flaticon.com/512/1544/1544834.png",
        "sizes": "512x512",
        "type": "image/png"
    }]
};
const stringManifest = JSON.stringify(manifest);
const blob = new Blob([stringManifest], {type: 'application/json'});
document.getElementById('my-manifest').setAttribute('href', URL.createObjectURL(blob));

// Service Worker の登録 (オフライン対応)
if ('serviceWorker' in navigator) {
    const swCode = `
        self.addEventListener('install', (e) => {
            e.waitUntil(caches.open('v1').then(cache => cache.addAll(['./'])));
        });
        self.addEventListener('fetch', (e) => {
            e.respondWith(caches.match(e.request).then(res => res || fetch(e.request)));
        });
    `;
    const swBlob = new Blob([swCode], {type: 'text/javascript'});
    const swUrl = URL.createObjectURL(swBlob);
    navigator.serviceWorker.register(swUrl);
}

/**
 * タイマーロジック
 */
let timeLeft = 25 * 60;
let timerId = null;
const display = document.getElementById('display');
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const historyList = document.getElementById('historyList');

function updateDisplay() {
    const m = Math.floor(timeLeft / 60);
    const s = timeLeft % 60;
    display.textContent = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
}

function saveLog(status, reason = "") {
    const logs = JSON.parse(localStorage.getItem('timerLogs') || "[]");
    const newLog = {
        date: new Date().toLocaleString(),
        status: status,
        reason: reason
    };
    logs.unshift(newLog);
    localStorage.setItem('timerLogs', JSON.stringify(logs));
    renderLogs();
}

function renderLogs() {
    const logs = JSON.parse(localStorage.getItem('timerLogs') || "[]");
    historyList.innerHTML = logs.map(log => `
        <div class="history-item">
            <strong>${log.date}</strong> - 
            <span class="${log.status === '完走' ? 'success-text' : 'fail-text'}">${log.status}</span>
            ${log.reason ? `<br><small>理由: ${log.reason}</small>` : ''}
        </div>
    `).join('');
}

startBtn.addEventListener('click', () => {
    if (timerId) return;
    startBtn.disabled = true;
    stopBtn.disabled = false;
    timerId = setInterval(() => {
        timeLeft--;
        updateDisplay();
        if (timeLeft <= 0) {
            clearInterval(timerId);
            timerId = null;
            alert("お疲れ様です！完走しました！");
            saveLog("完走");
            resetTimer();
        }
    }, 1000);
});

stopBtn.addEventListener('click', () => {
    const reason = prompt("中断する言い訳を入力してください：");
    if (reason !== null) {
        clearInterval(timerId);
        timerId = null;
        saveLog("挫折", reason || "無言の帰宅");
        resetTimer();
    }
});

function resetTimer() {
    timeLeft = 25 * 60;
    updateDisplay();
    startBtn.disabled = false;
    stopBtn.disabled = true;
}

renderLogs();
</script>
</body>
</html>